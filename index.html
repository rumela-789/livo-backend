<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FreePic</title>
    <style>
        :root {
            --primary: #00e676;
            --bg: #000;
            --surface: #1a1a1a;
            --text: #fff;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #camera-container {
            position: relative; flex: 1; width: 100%; background: #111; overflow: hidden;
        }

        video, canvas {
            width: 100%; height: 100%; object-fit: cover;
            position: absolute; top: 0; left: 0;
        }
        #video-feed { z-index: 1; }
        #processing-canvas { z-index: 2; display: none; }

        .flash-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 50; pointer-events: none; display: none;
        }
        @keyframes flash { 0% { opacity: 1; } 100% { opacity: 0; } }
        .do-flash { animation: flash 0.3s ease-out; }

        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; z-index: 10;
            padding: 10px 15px; padding-top: 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
        }
        
        .app-name { 
            font-weight: bold; font-size: 18px; color: var(--primary); 
            letter-spacing: 1px; text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        
        .top-controls { display: flex; gap: 12px; }

        .icon-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 38px; height: 38px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .controls-area {
            position: absolute; bottom: 0; left: 0; width: 100%; z-index: 10;
            padding: 20px 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }

        .selector-area {
            display: flex; gap: 15px; width: 100%; justify-content: center; padding: 0 15px;
        }

        .smart-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #ccc; padding: 8px 18px; border-radius: 20px; font-size: 14px;
            cursor: pointer; transition: 0.2s; white-space: nowrap; min-width: 100px; text-align: center;
        }
        .smart-btn.active {
            background: var(--primary); color: #000; font-weight: bold; border-color: var(--primary);
        }

        .config-drawer {
            position: absolute; bottom: 100px;
            left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 320px;
            height: 0;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid #444;
            overflow-y: auto;
            transition: height 0.3s ease;
            z-index: 15;
            display: flex; flex-direction: column;
        }
        .config-drawer.open { height: 200px; padding: 5px; border-color: var(--primary); }

        .config-item {
            padding: 12px; border-bottom: 1px solid #333; color: #eee; font-size: 14px;
            cursor: pointer; text-align: center;
        }
        .config-item:last-child { border-bottom: none; }
        .config-item:active { background: rgba(255,255,255,0.1); }
        .config-item.active { color: var(--primary); font-weight: bold; }

        .shutter-row {
            display: flex; align-items: center; justify-content: center; gap: 40px;
        }
        .shutter-btn {
            width: 70px; height: 70px; border-radius: 50%; border: 4px solid white;
            background: transparent; position: relative; cursor: pointer; transition: 0.1s;
        }
        .shutter-btn::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 56px; height: 56px; background: white; border-radius: 50%; transition: 0.2s;
        }
        .shutter-btn:active { transform: scale(0.95); }
        .shutter-btn:active::after { background: var(--primary); width: 50px; height: 50px; }
        .shutter-btn.recording { background: #ff3d00; border-color: #b71c1c; }
        .shutter-btn.recording::after { background: white; width: 24px; height: 24px; border-radius: 4px; }

        #settings-panel {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 20; display: none; flex-direction: column; padding: 20px;
            padding-top: 40px;
        }
        .panel-header { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        
        .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        #toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: white; padding: 10px 20px;
            border-radius: 5px; font-size: 14px; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
    </style>
</head>
<body>

    <div id="camera-container">
        <video id="video-feed" autoplay playsinline muted></video>
        <canvas id="processing-canvas"></canvas>
        <div class="flash-overlay" id="flash"></div>

        <div class="top-bar">
            <div class="app-name">FreePic</div>
            <div class="top-controls">
                <button class="icon-btn" onclick="switchCamera()">↻</button>
                <button class="icon-btn" onclick="toggleSettings()">⚙️</button>
            </div>
        </div>

        <div class="controls-area">
            <div class="selector-area">
                <button class="smart-btn active" id="btn-left" onclick="handleLeftClick()">Photo Mode</button>
                <button class="smart-btn" id="btn-right" onclick="handleRightClick()">Video Mode</button>
            </div>

            <div class="config-drawer" id="config-drawer">
                <div id="config-list-content"></div>
            </div>

            <div class="shutter-row">
                <div class="shutter-btn" id="shutter-btn" onclick="handleShutter()"></div>
            </div>
        </div>
    </div>

    <div id="settings-panel">
        <div class="panel-header">
            <h3 style="margin:0">Settings</h3>
            <button class="icon-btn" onclick="toggleSettings()">✕</button>
        </div>
        <div class="setting-row">
            <span>Auto Blur (Portrait)</span>
            <label class="switch"><input type="checkbox" id="blur-toggle"><span class="slider"></span></label>
        </div>
        <div class="setting-row">
            <span>Flash Light</span>
            <label class="switch">
                <input type="checkbox" id="torch-toggle" onchange="toggleTorch()">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div id="toast">Message</div>

    <script>
        // --- Configs with Samsung Ultra Logic ---
        const configs = [
            { id: 'samsung', name: 'Samsung Ultra', isAdvanced: true }, // Special Processing
            { id: 'iphone', name: 'iPhone Vivid', contrast: 10, saturation: 15, brightness: 5, tint: {r:-5,g:0,b:10} },
            { id: 'cinematic', name: 'Cinematic', contrast: 20, saturation: -10, brightness: -5, tint: {r:10,g:0,b:-10} },
            { id: 'vivo200', name: 'Vivo 200x', contrast: 25, saturation: 30, brightness: 10, tint: {r:5,g:10,b:5} },
            { id: 'bw', name: 'B&W Classic', contrast: 10, saturation: -100, brightness: 0, tint: null }
        ];

        let stream = null;
        let videoTrack = null;
        let facingMode = 'environment';
        let currentMode = 'photo';
        
        let leftState = { text: 'Photo Mode', status: 'mode', activeConfig: null };
        let rightState = { text: 'Video Mode', status: 'mode', activeConfig: null };

        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        let animationId = null;

        const video = document.getElementById('video-feed');
        const canvas = document.getElementById('processing-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const drawer = document.getElementById('config-drawer');
        const listContent = document.getElementById('config-list-content');
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');

        window.onload = initCamera;

        async function initCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode, width: {ideal:1920}, height: {ideal:1080} },
                    audio: true
                });
                video.srcObject = stream;
                video.play();
                const tracks = stream.getVideoTracks();
                if(tracks.length > 0) videoTrack = tracks[0];
            } catch(e) { showToast("Camera Permission Needed"); }
        }

        async function toggleTorch() {
            const checkbox = document.getElementById('torch-toggle');
            if (videoTrack) {
                try {
                    await videoTrack.applyConstraints({ advanced: [{ torch: checkbox.checked }] });
                } catch (err) { console.error(err); }
            }
        }

        function handleLeftClick() {
            currentMode = 'photo';
            btnLeft.classList.add('active'); btnRight.classList.remove('active');
            if (leftState.status === 'mode' || leftState.status === 'config') openDrawer('photo');
        }

        function handleRightClick() {
            currentMode = 'video';
            btnRight.classList.add('active'); btnLeft.classList.remove('active');
            if (rightState.status === 'mode' || rightState.status === 'config') openDrawer('video');
        }

        function openDrawer(mode) {
            currentMode = mode;
            renderConfigList();
            drawer.classList.add('open');
        }

        function closeDrawer() { drawer.classList.remove('open'); }

        function renderConfigList() {
            listContent.innerHTML = '';
            const noneDiv = document.createElement('div');
            noneDiv.className = 'config-item';
            noneDiv.innerText = 'None';
            noneDiv.onclick = () => selectConfig(null, 'None');
            listContent.appendChild(noneDiv);

            configs.forEach(cfg => {
                const div = document.createElement('div');
                div.className = 'config-item';
                const activeCfg = currentMode === 'photo' ? leftState.activeConfig : rightState.activeConfig;
                if (activeCfg && activeCfg.id === cfg.id) div.classList.add('active');
                div.innerText = cfg.name;
                div.onclick = () => selectConfig(cfg, cfg.name);
                listContent.appendChild(div);
            });
        }

        function selectConfig(cfg, name) {
            // For Preview (CSS)
            if (!cfg) {
                video.style.filter = 'none';
            } else if (cfg.id === 'samsung') {
                // Simulate Samsung look for preview
                video.style.filter = 'contrast(110%) saturate(125%) brightness(105%) sepia(10%) hue-rotate(-5deg)';
            } else {
                const f = `contrast(${100+cfg.contrast}%) saturate(${100+cfg.saturation}%) brightness(${100+cfg.brightness}%)`;
                video.style.filter = f;
            }

            if (currentMode === 'photo') {
                leftState.activeConfig = cfg;
                leftState.text = cfg ? name : 'Photo Mode';
                leftState.status = cfg ? 'config' : 'mode';
                btnLeft.innerText = leftState.text;
            } else {
                rightState.activeConfig = cfg;
                rightState.text = cfg ? name : 'Video Mode';
                rightState.status = cfg ? 'config' : 'mode';
                btnRight.innerText = rightState.text;
            }
            closeDrawer();
        }

        function switchCamera() {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            initCamera();
        }

        function toggleSettings() {
            const p = document.getElementById('settings-panel');
            p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
        }

        function handleShutter() {
            if (currentMode === 'video') toggleRecording();
            else takePhoto();
        }

        // --- Advanced Samsung Processing Algorithm ---
        function applySamsungGrading(imgData) {
            const d = imgData.data;
            for (let i = 0; i < d.length; i += 4) {
                let r = d[i], g = d[i+1], b = d[i+2];

                // 1. Deepen blacks and boost highlights slightly (Contrast curve simulation)
                if (r < 60) r -= 10; 
                else if (r > 200) r += 5;

                if (g < 60) g -= 10;
                else if (g > 200) g += 5;

                if (b < 60) b -= 10;
                else if (b > 200) b += 5;

                // 2. Boost Reds and Oranges (Warmth) - Key to Samsung look
                if (r > 100 && r > g && r > b) {
                    // If it's a reddish pixel
                    r += 10; 
                    g += 2; // Add slight orange tint
                }
                
                // 3. Increase Saturation selectively
                const avg = (r + g + b) / 3;
                const satMult = 1.25; // 25% more saturation
                r = avg + (r - avg) * satMult;
                g = avg + (g - avg) * satMult;
                b = avg + (b - avg) * satMult;

                // 4. Boost overall brightness slightly for that "Screen Pop"
                r += 5; g += 5; b += 5;

                // Clamp
                d[i] = Math.min(255, Math.max(0, r));
                d[i+1] = Math.min(255, Math.max(0, g));
                d[i+2] = Math.min(255, Math.max(0, b));
            }
        }

        function processImage(imgData, cfg) {
            if (cfg.id === 'samsung') {
                applySamsungGrading(imgData);
                return;
            }

            const d = imgData.data;
            const cFactor = (259 * (cfg.contrast + 255)) / (255 * (259 - cfg.contrast));
            const sFactor = (cfg.saturation + 100) / 100;

            for (let i = 0; i < d.length; i += 4) {
                let r = d[i], g = d[i+1], b = d[i+2];
                r += cfg.brightness; g += cfg.brightness; b += cfg.brightness;
                r = cFactor * (r - 128) + 128;
                g = cFactor * (g - 128) + 128;
                b = cFactor * (b - 128) + 128;
                const gray = 0.2989*r + 0.5870*g + 0.1140*b;
                r = gray + (r - gray) * sFactor;
                g = gray + (g - gray) * sFactor;
                b = gray + (b - gray) * sFactor;
                if (cfg.tint) { r += cfg.tint.r; g += cfg.tint.g; b += cfg.tint.b; }
                d[i] = Math.min(255, Math.max(0, r));
                d[i+1] = Math.min(255, Math.max(0, g));
                d[i+2] = Math.min(255, Math.max(0, b));
            }
        }

        function takePhoto() {
            const f = document.getElementById('flash');
            f.style.display = 'block'; f.classList.add('do-flash');
            setTimeout(() => { f.style.display = 'none'; f.classList.remove('do-flash'); }, 300);
            showToast("Processing...");

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.filter = 'none';
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            if (leftState.activeConfig) {
                processImage(imgData, leftState.activeConfig);
            }
            if (document.getElementById('blur-toggle').checked) applyBokeh(imgData, canvas.width, canvas.height);

            ctx.putImageData(imgData, 0, 0);
            const link = document.createElement('a');
            link.download = `FreePic_${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95); // High Quality
            link.click();
            showToast("Saved!");
        }

        function applyBokeh(imgData, w, h) {
            const d = imgData.data;
            const cx = w/2, cy = h/2;
            const maxDist = Math.sqrt(cx*cx + cy*cy);
            for (let y=0; y<h; y++) {
                for (let x=0; x<w; x++) {
                    const i = (y*w + x) * 4;
                    const dist = Math.sqrt((x-cx)**2 + (y-cy)**2) / maxDist;
                    if (dist > 0.4) {
                        const factor = (dist - 0.4) * 1.6;
                        const avg = (d[i]+d[i+1]+d[i+2])/3;
                        d[i] = d[i]*(1-factor) + avg*factor;
                        d[i+1] = d[i+1]*(1-factor) + avg*factor;
                        d[i+2] = d[i+2]*(1-factor) + avg*factor;
                        const dark = 1 - (factor*0.6);
                        d[i]*=dark; d[i+1]*=dark; d[i+2]*=dark;
                    }
                }
            }
        }

        function toggleRecording() {
            if (!isRecording) startRec();
            else stopRec();
        }

        function startRec() {
            recordedChunks = [];
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            video.style.display = 'none';
            canvas.style.display = 'block';
            drawVideoFrame();

            const stream = canvas.captureStream(30);
            const audioT = window.stream.getAudioTracks()[0];
            if(audioT) stream.addTrack(audioT);
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = saveVideo;
            mediaRecorder.start();
            isRecording = true;
            document.getElementById('shutter-btn').classList.add('recording');
            showToast("Recording...");
        }

        function drawVideoFrame() {
            if (!isRecording) return;
            // Note: Real-time Samsung processing for video is heavy. 
            // We use the CSS filter approximation for recording to keep FPS high.
            // But we apply it to the canvas context.
            const cfg = rightState.activeConfig;
            if (cfg && cfg.id === 'samsung') {
                ctx.filter = 'contrast(110%) saturate(125%) brightness(105%) sepia(10%) hue-rotate(-5deg)';
            } else if (cfg) {
                ctx.filter = `contrast(${100+cfg.contrast}%) saturate(${100+cfg.saturation}%) brightness(${100+cfg.brightness}%)`;
            } else {
                ctx.filter = 'none';
            }
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            animationId = requestAnimationFrame(drawVideoFrame);
        }

        function stopRec() {
            mediaRecorder.stop();
            isRecording = false;
            cancelAnimationFrame(animationId);
            document.getElementById('shutter-btn').classList.remove('recording');
            canvas.style.display = 'none';
            video.style.display = 'block';
            showToast("Saving Video...");
        }

        function saveVideo() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `FreePic_Video_${Date.now()}.webm`;
            a.click();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }
    </script>
</body>
</html>
